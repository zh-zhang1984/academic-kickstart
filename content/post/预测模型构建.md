---
title: "预测模型构建完整教程"
author: "章仲恒"
date: "8/10/2018"
output: 
  html_document:
    keep_md: true
    df_print: paged
    toc: true
    toc_float: true
    number_sections: true
    theme: united 
    highlight: tango
---



# Data generation (构建队列)
## Training data (构建训练队列)

```r
> set.seed(123)
> n <- 500
> age <- round(rnorm(n, 70, 15))
> gender <- sample(c("male", "female"), size = n, replace = T, prob = c(0.6, 0.4))
> lac <- round(abs(rnorm(n, 4.5, 2)), 1)
> type <- sample(c("surgery", "emergency", "medical"), size = n, replace = T, prob = c(0.3, 
+     0.4, 0.3))
> vaso <- sample(c("No", "Yes"), size = n, replace = T, prob = c(0.7, 0.3))
> wbc <- round(abs(rnorm(n, 10, 5)), 1)
> crp <- round(abs(rnorm(n, 150, 80)), 1)
> library(dummies)
```

```
## dummies-1.5.6 provided by Decision Patterns
```

```r
> beta0 = -30
> betaMed = 0.3
> betaSur = -3
> betaAge = 0.3
> betaLac = 2
> betaVaso = 3
> betaGender = -0.1
> betaWbc = -0.2
> betaCrp = 0.05
> linpred <- cbind(1, dummy(type)[, -1], age, lac, dummy(vaso)[, -1], dummy(gender)[, 
+     -1], wbc, crp) %*% c(beta0, betaMed, betaSur, betaAge, betaLac, betaVaso, betaGender, 
+     betaWbc, betaCrp)
```

```
## Warning in model.matrix.default(~x - 1, model.frame(~x - 1), contrasts = FALSE):
## non-list contrasts argument ignored

## Warning in model.matrix.default(~x - 1, model.frame(~x - 1), contrasts = FALSE):
## non-list contrasts argument ignored

## Warning in model.matrix.default(~x - 1, model.frame(~x - 1), contrasts = FALSE):
## non-list contrasts argument ignored
```

```r
> pi <- exp(linpred)/(1 + exp(linpred))
> mort <- rbinom(n = n, size = 1, prob = pi)
> lac.miss.tag <- rbinom(n, 1, 0.3)
> lac[lac <= 3 & lac.miss.tag == 1] <- NA  # NMAR
> wbc.miss.tag <- rbinom(n, 1, 0.2)
> wbc[wbc.miss.tag == 1] <- NA
> crp.miss.tag <- rbinom(n, 1, 0.4)
> crp[wbc <= 12 & crp.miss.tag == 1] <- NA  # MAR
> dt <- data.frame(age, gender, lac, type, vaso, wbc, crp, mort)
```
## External data (外部验证队列)

```r
> set.seed(1234)
> n <- 200
> age <- round(rnorm(n, 70, 15))
> gender <- sample(c("male", "female"), size = n, replace = T, prob = c(0.6, 0.4))
> lac <- round(abs(rnorm(n, 4.5, 2)), 1)
> type <- sample(c("surgery", "emergency", "medical"), size = n, replace = T, prob = c(0.3, 
+     0.4, 0.3))
> vaso <- sample(c("No", "Yes"), size = n, replace = T, prob = c(0.7, 0.3))
> wbc <- round(abs(rnorm(n, 10, 5)), 1)
> crp <- round(abs(rnorm(n, 150, 80)), 1)
> library(dummies)
> beta0 = -30
> betaMed = 0.3
> betaSur = -3
> betaAge = 0.3
> betaLac = 2
> betaVaso = 3
> betaGender = -0.1
> betaWbc = -0.2
> betaCrp = 0.05
> linpred <- cbind(1, dummy(type)[, -1], age, lac, dummy(vaso)[, -1], dummy(gender)[, 
+     -1], wbc, crp) %*% c(beta0, betaMed, betaSur, betaAge, betaLac, betaVaso, betaGender, 
+     betaWbc, betaCrp)
```

```
## Warning in model.matrix.default(~x - 1, model.frame(~x - 1), contrasts = FALSE):
## non-list contrasts argument ignored

## Warning in model.matrix.default(~x - 1, model.frame(~x - 1), contrasts = FALSE):
## non-list contrasts argument ignored

## Warning in model.matrix.default(~x - 1, model.frame(~x - 1), contrasts = FALSE):
## non-list contrasts argument ignored
```

```r
> pi <- exp(linpred)/(1 + exp(linpred))
> mort <- rbinom(n = n, size = 1, prob = pi)
> dt.ext <- data.frame(age, gender, lac, type, vaso, wbc, crp, mort)
```

## Read data from disc (从外部读取数据)

```r
> dt <- read.csv("/Users/zhang/Documents/2018/R大数据实战教程/模型预测/dt.csv")
> dt.ext <- read.csv("/Users/zhang/Documents/2018/R大数据实战教程/模型预测/dtext.csv")
```

# Manupulation of dataframe (数据框的一般操作)

```r
> nrow(dt)
```

```
## [1] 500
```

```r
> head(dt, 7)
```

<div data-pagedtable="false">
  <script data-pagedtable-source type="application/json">
{"columns":[{"label":[""],"name":["_rn_"],"type":[""],"align":["left"]},{"label":["age"],"name":[1],"type":["int"],"align":["right"]},{"label":["gender"],"name":[2],"type":["fctr"],"align":["left"]},{"label":["lac"],"name":[3],"type":["dbl"],"align":["right"]},{"label":["type"],"name":[4],"type":["fctr"],"align":["left"]},{"label":["vaso"],"name":[5],"type":["fctr"],"align":["left"]},{"label":["wbc"],"name":[6],"type":["dbl"],"align":["right"]},{"label":["crp"],"name":[7],"type":["dbl"],"align":["right"]},{"label":["mort"],"name":[8],"type":["int"],"align":["right"]}],"data":[{"1":"62","2":"male","3":"7.6","4":"surgery","5":"No","6":"6.5","7":"NA","8":"1","_rn_":"1"},{"1":"67","2":"male","3":"4.3","4":"medical","5":"Yes","6":"NA","7":"141.1","8":"1","_rn_":"2"},{"1":"93","2":"male","3":"5.5","4":"surgery","5":"No","6":"9.3","7":"37.0","8":"1","_rn_":"3"},{"1":"71","2":"female","3":"4.9","4":"emergency","5":"No","6":"4.4","7":"NA","8":"1","_rn_":"4"},{"1":"72","2":"female","3":"4.1","4":"medical","5":"No","6":"12.3","7":"212.7","8":"1","_rn_":"5"},{"1":"96","2":"male","3":"4.3","4":"medical","5":"No","6":"17.6","7":"222.1","8":"1","_rn_":"6"},{"1":"77","2":"female","3":"6.5","4":"medical","5":"Yes","6":"NA","7":"67.6","8":"1","_rn_":"7"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>

```r
> dt[1, 2]
```

```
## [1] male
## Levels: female male
```

```r
> dt[1:5, c("gender", "wbc")]
```

<div data-pagedtable="false">
  <script data-pagedtable-source type="application/json">
{"columns":[{"label":[""],"name":["_rn_"],"type":[""],"align":["left"]},{"label":["gender"],"name":[1],"type":["fctr"],"align":["left"]},{"label":["wbc"],"name":[2],"type":["dbl"],"align":["right"]}],"data":[{"1":"male","2":"6.5","_rn_":"1"},{"1":"male","2":"NA","_rn_":"2"},{"1":"male","2":"9.3","_rn_":"3"},{"1":"female","2":"4.4","_rn_":"4"},{"1":"female","2":"12.3","_rn_":"5"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>

```r
> dt_sub1 <- dt[dt$gender == "male" & dt$lac < 5, ]
> table(dt_sub1$gender)
```

```
## 
## female   male 
##      0    152
```

```r
> summary(dt_sub1$lac)
```

```
##    Min. 1st Qu.  Median    Mean 3rd Qu.    Max.    NA's 
##   0.100   2.500   3.600   3.347   4.300   4.900      24
```

```r
> dt_sub2 <- dt[dt$wbc > 10 | dt$crp > 50, ]
> summary(dt_sub2[dt_sub2$crp <= 50, "wbc"])
```

```
##    Min. 1st Qu.  Median    Mean 3rd Qu.    Max.    NA's 
##   10.20   13.15   14.90   15.38   17.15   22.20     123
```

# Missing data (缺失数据初探)
## Basic skills (R语言中缺失数据的一般处理方法)
参考文献 Zhang Z. Missing values in big data research: some basic skills. Ann Transl Med. 2015 Dec;3(21):323. doi: 10.3978/j.issn.2305-5839.2015.12.11.

```r
> is.na(dt$crp[1:20])
```

```
##  [1]  TRUE FALSE FALSE  TRUE FALSE FALSE FALSE FALSE  TRUE FALSE FALSE  TRUE
## [13] FALSE  TRUE FALSE FALSE FALSE FALSE FALSE  TRUE
```

```r
> which(is.na(dt$crp[1:20]))
```

```
## [1]  1  4  9 12 14 20
```

```r
> mean(dt$crp)
```

```
## [1] NA
```

```r
> sum(dt$crp)
```

```
## [1] NA
```

```r
> mean(dt$crp, na.rm = T)
```

```
## [1] 148.5743
```

```r
> sum(dt$crp, na.rm = T)
```

```
## [1] 57201.1
```

```r
> complete.dt <- dt[complete.cases(dt), ]
> nrow(complete.dt)
```

```
## [1] 272
```

## Missing data visulization (缺失数据的可视化)
参考文献：Zhang Z.Missing data exploration: highlighting graphical presentation of missing pattern.Ann Transl Med. 2015 Dec;3(22):356. doi: 10.3978/j.issn.2305-5839.2015.12.28.

```r
> library(mice)
```

```
## 
## Attaching package: 'mice'
```

```
## The following objects are masked from 'package:base':
## 
##     cbind, rbind
```

```r
> md.pattern(dt)
```

![](预测模型构建_files/figure-html/missing data visulization-1.png)<!-- -->

```
##     age gender type vaso mort lac wbc crp    
## 272   1      1    1    1    1   1   1   1   0
## 104   1      1    1    1    1   1   1   0   1
## 87    1      1    1    1    1   1   0   1   1
## 17    1      1    1    1    1   0   1   1   1
## 11    1      1    1    1    1   0   1   0   2
## 9     1      1    1    1    1   0   0   1   2
##       0      0    0    0    0  37  96 115 248
```

```r
> library(VIM)
```

```
## Loading required package: colorspace
```

```
## Loading required package: grid
```

```
## Loading required package: data.table
```

```
## VIM is ready to use. 
##  Since version 4.0.0 the GUI is in its own package VIMGUI.
## 
##           Please use the package to use the new (and old) GUI.
```

```
## Suggestions and bug-reports can be submitted at: https://github.com/alexkowa/VIM/issues
```

```
## 
## Attaching package: 'VIM'
```

```
## The following object is masked from 'package:datasets':
## 
##     sleep
```

```r
> aggr(dt, numbers = TRUE, prop = FALSE)
```

![](预测模型构建_files/figure-html/missing data visulization-2.png)<!-- -->

```r
> marginplot(dt[c("wbc", "crp")], pch = c(20), col = c("green", "red", "blue"))
```

![](预测模型构建_files/figure-html/missing data visulization-3.png)<!-- -->
  
缺失数据的三种类型：  
Missing completely at random (MCAR) refers to the presence of missing values on a variable that is unrelated to any other observed and unobserved variables In other words, there is no systematic reason for the missing pattern.

Missing at random (MAR) is the presence of missing values on a variable that is related to other observed variables but not related to its own unobserved values.  

Not missing at random (NMAR) is the presence of missing values on a variable that is neither MCAR nor MAR.      例如：乳酸正常水平的患者其乳酸会缺失。  

## Single imputation (单纯插补)
参考文献：Zhang Z. Missing data imputation: focusing on single imputation. Ann Transl Med. 2016 Jan;4(1):9. doi: 10.3978/j.issn.2305-5839.2015.12.38.

```r
> lac.mean <- ifelse(is.na(dt$lac), mean(dt$lac, na.rm = T), dt$lac)
> par(mfrow = c(1, 2))
> plot(1:nrow(dt), dt$lac)
> plot(1:length(lac.mean), lac.mean)
```

![](预测模型构建_files/figure-html/single imputation-1.png)<!-- -->

## Multiple imputataion (多重插补)
参考文献：Zhang Z.Multiple imputation with multivariate imputation by chained equation (MICE) package. Ann Transl Med. 2016 Jan;4(2):30. doi: 10.3978/j.issn.2305-5839.2015.12.63.


```r
> library(mice)
> imp <- mice(dt, seed = 12345)
```

```
## 
##  iter imp variable
##   1   1  lac  wbc  crp
##   1   2  lac  wbc  crp
##   1   3  lac  wbc  crp
##   1   4  lac  wbc  crp
##   1   5  lac  wbc  crp
##   2   1  lac  wbc  crp
##   2   2  lac  wbc  crp
##   2   3  lac  wbc  crp
##   2   4  lac  wbc  crp
##   2   5  lac  wbc  crp
##   3   1  lac  wbc  crp
##   3   2  lac  wbc  crp
##   3   3  lac  wbc  crp
##   3   4  lac  wbc  crp
##   3   5  lac  wbc  crp
##   4   1  lac  wbc  crp
##   4   2  lac  wbc  crp
##   4   3  lac  wbc  crp
##   4   4  lac  wbc  crp
##   4   5  lac  wbc  crp
##   5   1  lac  wbc  crp
##   5   2  lac  wbc  crp
##   5   3  lac  wbc  crp
##   5   4  lac  wbc  crp
##   5   5  lac  wbc  crp
```

```r
> imp
```

```
## Class: mids
## Number of multiple imputations:  5 
## Imputation methods:
##    age gender    lac   type   vaso    wbc    crp   mort 
##     ""     ""  "pmm"     ""     ""  "pmm"  "pmm"     "" 
## PredictorMatrix:
##        age gender lac type vaso wbc crp mort
## age      0      1   1    1    1   1   1    1
## gender   1      0   1    1    1   1   1    1
## lac      1      1   0    1    1   1   1    1
## type     1      1   1    0    1   1   1    1
## vaso     1      1   1    1    0   1   1    1
## wbc      1      1   1    1    1   0   1    1
```

```r
> head(imp$imp$lac)
```

<div data-pagedtable="false">
  <script data-pagedtable-source type="application/json">
{"columns":[{"label":[""],"name":["_rn_"],"type":[""],"align":["left"]},{"label":["1"],"name":[1],"type":["dbl"],"align":["right"]},{"label":["2"],"name":[2],"type":["dbl"],"align":["right"]},{"label":["3"],"name":[3],"type":["dbl"],"align":["right"]},{"label":["4"],"name":[4],"type":["dbl"],"align":["right"]},{"label":["5"],"name":[5],"type":["dbl"],"align":["right"]}],"data":[{"1":"3.2","2":"3.5","3":"2.9","4":"4.1","5":"0.7","_rn_":"9"},{"1":"3.8","2":"0.9","3":"3.3","4":"1.3","5":"1.6","_rn_":"14"},{"1":"5.2","2":"3.2","3":"4.8","4":"4.6","5":"7.4","_rn_":"21"},{"1":"4.0","2":"4.2","3":"4.9","4":"6.5","5":"7.6","_rn_":"35"},{"1":"4.3","2":"9.5","3":"6.4","4":"3.0","5":"10.2","_rn_":"42"},{"1":"2.6","2":"1.0","3":"4.4","4":"1.9","5":"3.8","_rn_":"62"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>

```r
> dtcom <- complete(imp, action = 4)
> # remove attributes to facilitate nomogram ploting
> attr(dtcom$gender, "contrasts") <- NULL
> attr(dtcom$type, "contrasts") <- NULL
> attr(dtcom$vaso, "contrasts") <- NULL
> head(dtcom)
```

<div data-pagedtable="false">
  <script data-pagedtable-source type="application/json">
{"columns":[{"label":[""],"name":["_rn_"],"type":[""],"align":["left"]},{"label":["age"],"name":[1],"type":["int"],"align":["right"]},{"label":["gender"],"name":[2],"type":["fctr"],"align":["left"]},{"label":["lac"],"name":[3],"type":["dbl"],"align":["right"]},{"label":["type"],"name":[4],"type":["fctr"],"align":["left"]},{"label":["vaso"],"name":[5],"type":["fctr"],"align":["left"]},{"label":["wbc"],"name":[6],"type":["dbl"],"align":["right"]},{"label":["crp"],"name":[7],"type":["dbl"],"align":["right"]},{"label":["mort"],"name":[8],"type":["int"],"align":["right"]}],"data":[{"1":"62","2":"male","3":"7.6","4":"surgery","5":"No","6":"6.5","7":"157.4","8":"1","_rn_":"1"},{"1":"67","2":"male","3":"4.3","4":"medical","5":"Yes","6":"15.6","7":"141.1","8":"1","_rn_":"2"},{"1":"93","2":"male","3":"5.5","4":"surgery","5":"No","6":"9.3","7":"37.0","8":"1","_rn_":"3"},{"1":"71","2":"female","3":"4.9","4":"emergency","5":"No","6":"4.4","7":"77.9","8":"1","_rn_":"4"},{"1":"72","2":"female","3":"4.1","4":"medical","5":"No","6":"12.3","7":"212.7","8":"1","_rn_":"5"},{"1":"96","2":"male","3":"4.3","4":"medical","5":"No","6":"17.6","7":"222.1","8":"1","_rn_":"6"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>

## Estimations post-imputation (插补后的运算)

```r
> ttest <- with(imp, t.test(lac ~ mort))
> ttest
```

```
## call :
## with.mids(data = imp, expr = t.test(lac ~ mort))
## 
## call1 :
## mice(data = dt, seed = 12345)
## 
## nmis :
##    age gender    lac   type   vaso    wbc    crp   mort 
##      0      0     37      0      0     96    115      0 
## 
## analyses :
## [[1]]
## 
## 	Welch Two Sample t-test
## 
## data:  lac by mort
## t = -8.4485, df = 201.59, p-value = 5.832e-15
## alternative hypothesis: true difference in means is not equal to 0
## 95 percent confidence interval:
##  -1.954246 -1.214653
## sample estimates:
## mean in group 0 mean in group 1 
##        3.512174        5.096623 
## 
## 
## [[2]]
## 
## 	Welch Two Sample t-test
## 
## data:  lac by mort
## t = -8.4139, df = 191.56, p-value = 9.06e-15
## alternative hypothesis: true difference in means is not equal to 0
## 95 percent confidence interval:
##  -1.996494 -1.238198
## sample estimates:
## mean in group 0 mean in group 1 
##        3.453043        5.070390 
## 
## 
## [[3]]
## 
## 	Welch Two Sample t-test
## 
## data:  lac by mort
## t = -8.1171, df = 201.35, p-value = 4.674e-14
## alternative hypothesis: true difference in means is not equal to 0
## 95 percent confidence interval:
##  -1.858937 -1.132300
## sample estimates:
## mean in group 0 mean in group 1 
##        3.592174        5.087792 
## 
## 
## [[4]]
## 
## 	Welch Two Sample t-test
## 
## data:  lac by mort
## t = -8.3559, df = 199.02, p-value = 1.104e-14
## alternative hypothesis: true difference in means is not equal to 0
## 95 percent confidence interval:
##  -1.956990 -1.209673
## sample estimates:
## mean in group 0 mean in group 1 
##        3.510435        5.093766 
## 
## 
## [[5]]
## 
## 	Welch Two Sample t-test
## 
## data:  lac by mort
## t = -7.8985, df = 201, p-value = 1.809e-13
## alternative hypothesis: true difference in means is not equal to 0
## 95 percent confidence interval:
##  -1.876218 -1.126583
## sample estimates:
## mean in group 0 mean in group 1 
##        3.596522        5.097922
```

```r
> fit <- with(imp, glm(mort ~ gender + age + lac + crp + wbc, family = binomial))
> pooled <- pool(fit)
> summary(pooled)
```

<div data-pagedtable="false">
  <script data-pagedtable-source type="application/json">
{"columns":[{"label":["term"],"name":[1],"type":["fctr"],"align":["left"]},{"label":["estimate"],"name":[2],"type":["dbl"],"align":["right"]},{"label":["std.error"],"name":[3],"type":["dbl"],"align":["right"]},{"label":["statistic"],"name":[4],"type":["dbl"],"align":["right"]},{"label":["df"],"name":[5],"type":["dbl"],"align":["right"]},{"label":["p.value"],"name":[6],"type":["dbl"],"align":["right"]}],"data":[{"1":"(Intercept)","2":"-17.76590132","3":"2.304128859","4":"-7.7104634","5":"59.43130","6":"1.619225e-10"},{"1":"gendermale","2":"-0.12468295","3":"0.369693482","4":"-0.3372603","5":"239.61390","6":"7.362159e-01"},{"1":"age","2":"0.18019216","3":"0.022426741","4":"8.0347009","5":"178.24200","6":"1.241229e-13"},{"1":"lac","2":"1.09733661","3":"0.178577856","4":"6.1448639","5":"22.97054","6":"2.886235e-06"},{"1":"crp","2":"0.02724018","3":"0.004166186","4":"6.5383991","5":"45.94020","6":"4.523252e-08"},{"1":"wbc","2":"-0.08772365","3":"0.044968152","4":"-1.9507950","5":"44.18010","6":"5.744186e-02"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>

```r
> fit.origin <- glm(mort ~ gender + age + lac + crp + wbc, family = binomial, dt)
> summary(fit.origin)
```

```
## 
## Call:
## glm(formula = mort ~ gender + age + lac + crp + wbc, family = binomial, 
##     data = dt)
## 
## Deviance Residuals: 
##      Min        1Q    Median        3Q       Max  
## -2.68013   0.00206   0.06586   0.34273   2.11188  
## 
## Coefficients:
##               Estimate Std. Error z value Pr(>|z|)    
## (Intercept) -17.849062   2.712110  -6.581 4.67e-11 ***
## gendermale    0.043905   0.468646   0.094    0.925    
## age           0.177039   0.028168   6.285 3.28e-10 ***
## lac           1.152290   0.191585   6.014 1.80e-09 ***
## crp           0.029334   0.004965   5.908 3.47e-09 ***
## wbc          -0.102462   0.049885  -2.054    0.040 *  
## ---
## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
## 
## (Dispersion parameter for binomial family taken to be 1)
## 
##     Null deviance: 301.44  on 271  degrees of freedom
## Residual deviance: 128.73  on 266  degrees of freedom
##   (228 observations deleted due to missingness)
## AIC: 140.73
## 
## Number of Fisher Scoring iterations: 7
```
未插补的队列因为样本量较小，其置信区间较宽，不稳定。

# Univariate analysis (单变量分析：构建模型的第一步)
参考文献：  
1、Zhang Z. Univariate description and bivariate statistical inference: the first step delving into data. Ann Transl Med. 2016 Mar;4(5):91. doi: 10.21037/atm.2016.02.11.  
2、Zhang Z, Gayle AA, Wang J, Zhang H,Cardinal-Fernández P. Comparing baseline characteristics between groups: an introduction to the CBCgrps package. Ann Transl Med 2017;5(24):484. doi: 10.21037/atm.2017.09.39

```r
> library(CBCgrps)
```

```
## Loading required package: nortest
```

```r
> tab1 <- twogrps(dtcom, gvar = "mort")
> print(tab1, quote = T)
```

```
## $Table
##                                                                        
## 1       "Variables" "Total (n = 500)"    "0 (n = 115)"    "1 (n = 385)"
## 2  "age, Mean ± SD"   "70.53 ± 14.62"  "58.48 ± 11.43"  "74.13 ± 13.51"
## 3   "gender, n (%)"                ""               ""               ""
## 4        "  female"        "188 (38)"        "44 (38)"       "144 (37)"
## 5          "  male"        "312 (62)"        "71 (62)"       "241 (63)"
## 6  "lac, Mean ± SD"     "4.73 ± 1.97"    "3.51 ± 1.75"    "5.09 ± 1.88"
## 7     "type, n (%)"                ""               ""               ""
## 8     "  emergency"        "193 (39)"        "38 (33)"       "155 (40)"
## 9       "  medical"        "147 (29)"        "21 (18)"       "126 (33)"
## 10      "  surgery"        "160 (32)"        "56 (49)"       "104 (27)"
## 11    "vaso, n (%)"                ""               ""               ""
## 12           "  No"        "353 (71)"       "102 (89)"       "251 (65)"
## 13          "  Yes"        "147 (29)"        "13 (11)"       "134 (35)"
## 14 "wbc, Mean ± SD"     "9.81 ± 4.75"   "10.29 ± 4.91"     "9.66 ± 4.7"
## 15 "crp, Mean ± SD"  "150.09 ± 75.82" "102.44 ± 61.23" "164.33 ± 73.99"
##             
## 1        "p"
## 2  "< 0.001"
## 3    "0.955"
## 4         ""
## 5         ""
## 6  "< 0.001"
## 7  "< 0.001"
## 8         ""
## 9         ""
## 10        ""
## 11 "< 0.001"
## 12        ""
## 13        ""
## 14   "0.222"
## 15 "< 0.001"
## 
## $VarExtract
## [1] "age"  "lac"  "type" "vaso" "crp"
```

# Model training and validation (模型构建)
## Purposeful selection (目的性建模)
在模型中可以加入单变量分析中p<0.2-0.25的因素，另外可加入研究者认为对结局有影响的变量（有些变量单变量分析无统计学差异，但多变量分析出现差异；需要专业知识去识别）。  
参考文献：  
Zhang Z. Model building strategy for logistic regression: purposeful selection. Ann Transl Med 2016;4(6):111. doi: 10.21037/atm.2016.02.15

```r
> mod1 <- glm(mort ~ age + lac + wbc + crp + type + vaso, dtcom, family = "binomial")
> summary(mod1)
```

```
## 
## Call:
## glm(formula = mort ~ age + lac + wbc + crp + type + vaso, family = "binomial", 
##     data = dtcom)
## 
## Deviance Residuals: 
##      Min        1Q    Median        3Q       Max  
## -2.12712   0.00013   0.00785   0.11449   2.83530  
## 
## Coefficients:
##               Estimate Std. Error z value Pr(>|z|)    
## (Intercept) -30.663473   4.206620  -7.289 3.11e-13 ***
## age           0.295898   0.040939   7.228 4.91e-13 ***
## lac           1.958832   0.280477   6.984 2.87e-12 ***
## wbc          -0.085368   0.050977  -1.675   0.0940 .  
## crp           0.044022   0.006391   6.888 5.66e-12 ***
## typemedical   1.291449   0.625106   2.066   0.0388 *  
## typesurgery  -3.308545   0.654438  -5.056 4.29e-07 ***
## vasoYes       3.279120   0.656080   4.998 5.79e-07 ***
## ---
## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
## 
## (Dispersion parameter for binomial family taken to be 1)
## 
##     Null deviance: 539.28  on 499  degrees of freedom
## Residual deviance: 130.81  on 492  degrees of freedom
## AIC: 146.81
## 
## Number of Fisher Scoring iterations: 8
```

```r
> mod2 <- glm(mort ~ age + lac + crp + type + vaso, dtcom, family = "binomial")
> summary(mod2)
```

```
## 
## Call:
## glm(formula = mort ~ age + lac + crp + type + vaso, family = "binomial", 
##     data = dtcom)
## 
## Deviance Residuals: 
##      Min        1Q    Median        3Q       Max  
## -2.33209   0.00015   0.00825   0.11498   2.80626  
## 
## Coefficients:
##               Estimate Std. Error z value Pr(>|z|)    
## (Intercept) -31.356126   4.241440  -7.393 1.44e-13 ***
## age           0.294291   0.040619   7.245 4.32e-13 ***
## lac           1.970330   0.284698   6.921 4.49e-12 ***
## crp           0.043026   0.006236   6.900 5.21e-12 ***
## typemedical   1.387126   0.628654   2.207   0.0273 *  
## typesurgery  -3.359554   0.654620  -5.132 2.87e-07 ***
## vasoYes       3.252624   0.638253   5.096 3.47e-07 ***
## ---
## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
## 
## (Dispersion parameter for binomial family taken to be 1)
## 
##     Null deviance: 539.28  on 499  degrees of freedom
## Residual deviance: 133.72  on 493  degrees of freedom
## AIC: 147.72
## 
## Number of Fisher Scoring iterations: 8
```

```r
> delta.coef <- abs((coef(mod2) - coef(mod1)[-4])/coef(mod1)[-4])
> round(delta.coef, 3)
```

```
## (Intercept)         age         lac         crp typemedical typesurgery 
##       0.023       0.005       0.006       0.023       0.074       0.015 
##     vasoYes 
##       0.008
```

## Comparing two models (比较两个模型的优劣)

```r
> library(lmtest)
```

```
## Loading required package: zoo
```

```
## 
## Attaching package: 'zoo'
```

```
## The following objects are masked from 'package:base':
## 
##     as.Date, as.Date.numeric
```

```r
> lrtest(mod1, mod2)
```

<div data-pagedtable="false">
  <script data-pagedtable-source type="application/json">
{"columns":[{"label":[""],"name":["_rn_"],"type":[""],"align":["left"]},{"label":["#Df"],"name":[1],"type":["dbl"],"align":["right"]},{"label":["LogLik"],"name":[2],"type":["dbl"],"align":["right"]},{"label":["Df"],"name":[3],"type":["dbl"],"align":["right"]},{"label":["Chisq"],"name":[4],"type":["dbl"],"align":["right"]},{"label":["Pr(>Chisq)"],"name":[5],"type":["dbl"],"align":["right"]}],"data":[{"1":"8","2":"-65.40614","3":"NA","4":"NA","5":"NA","_rn_":"1"},{"1":"7","2":"-66.85886","3":"-1","4":"2.905443","5":"0.08828102","_rn_":"2"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>

```r
> anova(mod1, mod2, test = "Chisq")
```

<div data-pagedtable="false">
  <script data-pagedtable-source type="application/json">
{"columns":[{"label":[""],"name":["_rn_"],"type":[""],"align":["left"]},{"label":["Resid. Df"],"name":[1],"type":["dbl"],"align":["right"]},{"label":["Resid. Dev"],"name":[2],"type":["dbl"],"align":["right"]},{"label":["Df"],"name":[3],"type":["dbl"],"align":["right"]},{"label":["Deviance"],"name":[4],"type":["dbl"],"align":["right"]},{"label":["Pr(>Chi)"],"name":[5],"type":["dbl"],"align":["right"]}],"data":[{"1":"492","2":"130.8123","3":"NA","4":"NA","5":"NA","_rn_":"1"},{"1":"493","2":"133.7177","3":"-1","4":"-2.905443","5":"0.08828102","_rn_":"2"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>

## Linearity assumption (线性假设验证)
方法：residuals versus individual independent variables.  
参考文献：Zhang Z. Residuals and regression diagnostics: focusing on logistic regression. Ann Transl Med. 2016 May;4(10):195. doi: 10.21037/atm.2016.03.36.

```r
> library(car)
```

```
## Loading required package: carData
```

```r
> residualPlots(mod1, terms = ~age + lac + wbc + crp, fitted = T)
```

![](预测模型构建_files/figure-html/unnamed-chunk-4-1.png)<!-- -->

```
##     Test stat Pr(>|Test stat|)
## age    0.0963           0.7564
## lac    0.2227           0.6370
## wbc    0.9215           0.3371
## crp    0.5616           0.4536
```


```r
> mod3 <- glm(mort ~ age + I(age^2) + lac + crp + type + vaso, dtcom, family = "binomial")
> lrtest(mod2, mod3)
```

<div data-pagedtable="false">
  <script data-pagedtable-source type="application/json">
{"columns":[{"label":[""],"name":["_rn_"],"type":[""],"align":["left"]},{"label":["#Df"],"name":[1],"type":["dbl"],"align":["right"]},{"label":["LogLik"],"name":[2],"type":["dbl"],"align":["right"]},{"label":["Df"],"name":[3],"type":["dbl"],"align":["right"]},{"label":["Chisq"],"name":[4],"type":["dbl"],"align":["right"]},{"label":["Pr(>Chisq)"],"name":[5],"type":["dbl"],"align":["right"]}],"data":[{"1":"7","2":"-66.85886","3":"NA","4":"NA","5":"NA","_rn_":"1"},{"1":"8","2":"-66.83410","3":"1","4":"0.0495282","5":"0.8238863","_rn_":"2"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>

## Interaction (交互作用探讨)

```r
> model.interaction <- glm(mort ~ age + lac * vaso + wbc + crp + type, data = dtcom, 
+     family = binomial)
> summary(model.interaction)
```

```
## 
## Call:
## glm(formula = mort ~ age + lac * vaso + wbc + crp + type, family = binomial, 
##     data = dtcom)
## 
## Deviance Residuals: 
##      Min        1Q    Median        3Q       Max  
## -2.16134   0.00009   0.00675   0.10168   2.79983  
## 
## Coefficients:
##               Estimate Std. Error z value Pr(>|z|)    
## (Intercept) -30.697656   4.193222  -7.321 2.47e-13 ***
## age           0.299753   0.041300   7.258 3.93e-13 ***
## lac           1.861767   0.278824   6.677 2.44e-11 ***
## vasoYes       1.574654   1.303838   1.208   0.2272    
## wbc          -0.079286   0.051989  -1.525   0.1272    
## crp           0.045128   0.006589   6.849 7.45e-12 ***
## typemedical   1.298569   0.626143   2.074   0.0381 *  
## typesurgery  -3.339791   0.655137  -5.098 3.44e-07 ***
## lac:vasoYes   0.497703   0.349928   1.422   0.1549    
## ---
## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
## 
## (Dispersion parameter for binomial family taken to be 1)
## 
##     Null deviance: 539.28  on 499  degrees of freedom
## Residual deviance: 128.63  on 491  degrees of freedom
## AIC: 146.63
## 
## Number of Fisher Scoring iterations: 8
```

```r
> lrtest(mod1, model.interaction)
```

<div data-pagedtable="false">
  <script data-pagedtable-source type="application/json">
{"columns":[{"label":[""],"name":["_rn_"],"type":[""],"align":["left"]},{"label":["#Df"],"name":[1],"type":["dbl"],"align":["right"]},{"label":["LogLik"],"name":[2],"type":["dbl"],"align":["right"]},{"label":["Df"],"name":[3],"type":["dbl"],"align":["right"]},{"label":["Chisq"],"name":[4],"type":["dbl"],"align":["right"]},{"label":["Pr(>Chisq)"],"name":[5],"type":["dbl"],"align":["right"]}],"data":[{"1":"8","2":"-65.40614","3":"NA","4":"NA","5":"NA","_rn_":"1"},{"1":"9","2":"-64.31637","3":"1","4":"2.179551","5":"0.1398552","_rn_":"2"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>

## Visulization of interaction (交互作用的可视化)

```r
> library(visreg)
> visreg(model.interaction, xvar = "lac", by = "vaso", scale = "response")
```

![](预测模型构建_files/figure-html/unnamed-chunk-7-1.png)<!-- -->

## Model fit (模型拟合的判断)

```r
> library(ResourceSelection)
```

```
## ResourceSelection 0.3-5 	 2019-07-22
```

```r
> hoslem.test(mod1$y, fitted(mod1))
```

```
## 
## 	Hosmer and Lemeshow goodness of fit (GOF) test
## 
## data:  mod1$y, fitted(mod1)
## X-squared = 2.7764, df = 8, p-value = 0.9476
```

```r
> Predprob <- predict(mod1, type = "response")
> plot(Predprob, jitter(as.numeric(dtcom$mort), 0.5), cex = 0.5, ylab = "Jittered mortality outcome")
```

![](预测模型构建_files/figure-html/unnamed-chunk-8-1.png)<!-- -->

```r
> library(lattice)
> histogram(~Predprob | dtcom$mort)
```

![](预测模型构建_files/figure-html/unnamed-chunk-8-2.png)<!-- -->

```r
> library(pROC)
```

```
## Type 'citation("pROC")' for a citation.
```

```
## 
## Attaching package: 'pROC'
```

```
## The following object is masked from 'package:colorspace':
## 
##     coords
```

```
## The following objects are masked from 'package:stats':
## 
##     cov, smooth, var
```

```r
> plot.roc(roc(dtcom$mort, Predprob), print.auc = TRUE)
```

```
## Setting levels: control = 0, case = 1
```

```
## Setting direction: controls < cases
```

![](预测模型构建_files/figure-html/unnamed-chunk-8-3.png)<!-- -->

## Make table 2(模型制表表示)

```r
> tab2 <- cbind(paste(round(exp(coef(mod1)), 3), "(", round(exp(confint(mod1))[, 1], 
+     3), "~", round(exp(confint(mod1))[, 2], 3), ")", sep = ""), round(summary(mod1)$coefficient[, 
+     4], 3))
```

```
## Waiting for profiling to be done...
## Waiting for profiling to be done...
```

```r
> tab2
```

```
##             [,1]                    [,2]   
## (Intercept) "0(0~0)"                "0"    
## age         "1.344(1.251~1.471)"    "0"    
## lac         "7.091(4.342~13.17)"    "0"    
## wbc         "0.918(0.828~1.013)"    "0.094"
## crp         "1.045(1.033~1.06)"     "0"    
## typemedical "3.638(1.106~13.065)"   "0.039"
## typesurgery "0.037(0.009~0.121)"    "0"    
## vasoYes     "26.552(8.093~108.251)" "0"
```

## Net reclassification improvement
Net reclassification improvement (NRI) is an index that attempts to quantify how well a new model reclassifies subjects - either appropriately or inappropriately - as compared to an old model.How well a new model correctly reclassifies cases, was introduced through the metric of NRI.  
一些重要概念:  

$$
\begin{aligned}
  NRI=\frac{\sum_{i\ in\ events} v(i)}{events(n)}-\frac{\sum_{i\ in\ nonevents} v(j)}{nonevents(n)}
\end{aligned}
$$
$v(i)$为移动标示，向上移动时$v(i)=1$,向下移动时$v(i)=-1$，不动时$v(i)=0$。当风险划分为有限几个区域时，称为分类的NRI；当不分类，即每个病人自身的风险为一个作为一个类别时，称为连续的NRI。    

解释NRI的示意图: ![](/Users/zhang/Documents/2018/R大数据实战教程/模型预测/Reclassification_table_example.gif)

In a perfect test, all subjects with events would be classified as abnormal and all subjects without events would be classified as normal. Bold indicates subjects correctly classified by both tests. White indicates subjects incorrectly classified by both tests. Green indicates subjects correctly reclassified by test 2. Red indicates subjects incorrectly reclassified by test 2.  

$$
\begin{aligned}
  \hat{IDI}=\frac{\sum_{i\ in\ events} (\hat{p}_{new}(i)-\hat{p}_{old}(i))}{events(n)}-\frac{\sum_{i\ in\ nonevents} (\hat{p}_{new}(j)-\hat{p}_{old}(j))}{nonevents(n)}
\end{aligned}
$$

> We show in the Appendix that **the first term** in (2) quantifies **improvement in sensitivity** and the negative of the second term quantifies **improvement in specificity**. Also, by rearranging the terms in (2), we observe that it is equivalent to the difference in discrimination slopes as introduced by Yates (*discrimination slope can be defined as a difference between mean predicted probabilities of an event for those with events and the corresponding mean for those without events*).

> The difference in model-based discrimination slopes is an important measure of improvement in model performance. As shown in the Appendix, it is a sample equivalent of the difference between the *integrated difference in sensitivities and the integrated difference in ‘one minus specificities’ between the new and old models*. This integration is over all possible cut-offs. Thus, it quantifies jointly the **overall improvement in sensitivity and specificity**. In simpler terms, the area under the sensitivity curve is estimated by the mean of predicted probabilities of an event for those who experience events, and the area under the ‘one minus specificity’ curve is estimated by the mean of predicted probabilities of an event for those who do not experience events. We suggest the integrated differences in sensitivities and ‘one minus specificities’ and their difference as another measure of improvement in performance offered by the new marker. We call the last difference the **IDI** and estimate it using *the difference in discrimination slopes*. A simple asymptotic test of significance is provided in the next section.

参考文献：  
Ann Intern Med. 2014;160(2):122-131.   
Statist. Med. 2008; 27:157–172.  


```r
> library(PredictABEL)
> riskmod1 <- fitLogRegModel(data = dtcom, cOutcome = 8, cNonGenPreds = c(1), cNonGenPredsCat = c(2), 
+     cGenPreds = c(0), cGenPredsCat = c(0))
> riskmod2 <- fitLogRegModel(data = dtcom, cOutcome = 8, cNonGenPreds = c(1, 3, 6, 
+     7), cNonGenPredsCat = c(2, 4, 5), cGenPreds = c(0), cGenPredsCat = c(0))
> predrisk1 <- predRisk(riskmod1, data = dtcom)
> predrisk2 <- predRisk(riskmod2, data = dtcom)
> reclassification(data = dtcom, cOutcome = 8, predrisk1, predrisk2, cutoff = c(0, 
+     0.2, 0.3, 1))
```

```
##  _________________________________________
##  
##      Reclassification table    
##  _________________________________________
## 
##  Outcome: absent 
##   
##              Updated Model
## Initial Model [0,0.2) [0.2,0.3) [0.3,1]  % reclassified
##     [0,0.2)         8         1       0              11
##     [0.2,0.3)       5         0       0             100
##     [0.3,1]        67         9      25              75
## 
##  
##  Outcome: present 
##   
##              Updated Model
## Initial Model [0,0.2) [0.2,0.3) [0.3,1]  % reclassified
##     [0,0.2)         0         0       0             NaN
##     [0.2,0.3)       1         0       3             100
##     [0.3,1]         1         3     377               1
## 
##  
##  Combined Data 
##   
##              Updated Model
## Initial Model [0,0.2) [0.2,0.3) [0.3,1]  % reclassified
##     [0,0.2)         8         1       0              11
##     [0.2,0.3)       6         0       3             100
##     [0.3,1]        68        12     402              17
##  _________________________________________
## 
##  NRI(Categorical) [95% CI]: 0.6905 [ 0.6018 - 0.7791 ] ; p-value: 0 
##  NRI(Continuous) [95% CI]: 1.6321 [ 1.5105 - 1.7536 ] ; p-value: 0 
##  IDI [95% CI]: 0.5441 [ 0.4874 - 0.6008 ] ; p-value: 0
```

```r
> # plot ROC curve for both models
> plotROC(data = dtcom, cOutcome = 8, predrisk = cbind(predrisk1, predrisk2), labels = c("simple", 
+     "full"), plottitle = "ROC plots for mortality discrimination")
```

![](预测模型构建_files/figure-html/unnamed-chunk-9-1.png)<!-- -->

```
## AUC [95% CI] for the model 1 :  0.811 [ 0.77  -  0.852 ] 
## AUC [95% CI] for the model 2 :  0.985 [ 0.978  -  0.993 ]
```

```r
> # Box Plots Of Predicted Risks Separately For Individuals With And Without The
> # Outcome Of Interest.
> plotDiscriminationBox(data = dtcom, cOutcome = 8, predrisk = predrisk1, labels = c("without event", 
+     "with event"), plottitle = "Box plots for mortality discrimination")
```

![](预测模型构建_files/figure-html/unnamed-chunk-9-2.png)<!-- -->

```
## $Discrim_Slope
## [1] 0.228
```

```r
> plotDiscriminationBox(data = dtcom, cOutcome = 8, predrisk = predrisk2, labels = c("without event", 
+     "with event"), plottitle = "Box plots for mortality discrimination")
```

![](预测模型构建_files/figure-html/unnamed-chunk-9-3.png)<!-- -->

```
## $Discrim_Slope
## [1] 0.772
```
两个模型Discrimination slope的差值等于IDI，其中:   

> **discrimination slope** can be defined as a difference between mean predicted probabilities of an event for those with events and the corresponding mean for those without events

```r
> # calibration plot
> plotCalibration(data = dtcom, cOutcome = 8, predrisk1, groups = 15, plottitle = "Calibration plot for model 1")
```

![](预测模型构建_files/figure-html/calibration plot-1.png)<!-- -->

```
## $Table_HLtest
##                total meanpred meanobs predicted observed
## [0.0808,0.392)    37    0.272   0.324     10.06       12
## [0.3924,0.535)    34    0.468   0.500     15.92       17
## [0.5354,0.635)    32    0.581   0.531     18.61       17
## [0.6347,0.700)    35    0.664   0.800     23.26       28
## [0.7004,0.740)    32    0.718   0.500     22.96       16
## [0.7402,0.791)    38    0.762   0.763     28.94       29
## [0.7907,0.824)    30    0.804   0.733     24.12       22
## [0.8237,0.861)    37    0.840   0.865     31.07       32
## [0.8611,0.874)    25    0.865   0.800     21.63       20
## [0.8741,0.903)    34    0.890   0.912     30.25       31
## [0.9033,0.932)    35    0.914   0.943     32.00       33
## [0.9319,0.948)    32    0.937   0.938     29.97       30
## [0.9485,0.968)    37    0.956   0.973     35.38       36
## [0.9679,0.982)    29    0.974   1.000     28.23       29
## [0.9820,0.998]    33    0.988   1.000     32.62       33
## 
## $Chi_square
## [1] 15.33
## 
## $df
## [1] 13
## 
## $p_value
## [1] 0.2872
```

```r
> plotCalibration(data = dtcom, cOutcome = 8, predrisk2, groups = 15, plottitle = "Calibration plot for model 2")
```

![](预测模型构建_files/figure-html/calibration plot-2.png)<!-- -->

```
## $Table_HLtest
##                    total meanpred meanobs predicted observed
## [5.78e-07,0.00357)    34    0.001   0.000      0.03        0
## [3.57e-03,0.04740)    33    0.019   0.030      0.63        1
## [4.74e-02,0.35295)    33    0.186   0.182      6.12        6
## [3.53e-01,0.75759)    34    0.583   0.588     19.81       20
## [7.58e-01,0.91112)    33    0.847   0.758     27.94       25
## [9.11e-01,0.97062)    33    0.947   1.000     31.26       33
## [9.71e-01,0.99118)    34    0.983   1.000     33.42       34
## [9.91e-01,0.99763)    33    0.995   1.000     32.84       33
## [9.98e-01,0.99936)    33    0.999   1.000     32.95       33
## [9.99e-01,0.99987)    34    1.000   1.000     33.99       34
## [1.00e+00,0.99997)    33    1.000   1.000     33.00       33
## [1.00e+00,0.99999)    33    1.000   1.000     33.00       33
## [1.00e+00,1.00000)    34    1.000   1.000     34.00       34
## [1.00e+00,1.00000)    33    1.000   1.000     33.00       33
## [1.00e+00,1.00000]    33    1.000   1.000     33.00       33
## 
## $Chi_square
## [1] NaN
## 
## $df
## [1] 13
## 
## $p_value
## [1] NaN
```

## Model recalibration (利用外部数据进行模型重新校正)
参考文献：BMC Med Res Methodol. 2012 Jul 20;12:99. doi: 10.1186/1471-2288-12-99.

```r
> Provalid <- predict(mod1, newdata = dt.ext)
> modvalid <- glm(dt.ext$mort ~ Provalid, family = "binomial")
> coeff.recal <- coefficients(mod1) * coefficients(modvalid)[2]  #shrinkage factor
> coeff.recal
```

```
##  (Intercept)          age          lac          wbc          crp  typemedical 
## -21.82061921   0.21056554   1.39393602  -0.06074900   0.03132684   0.91901560 
##  typesurgery      vasoYes 
##  -2.35441384   2.33347457
```

```r
> coefficients(mod1)  #校正后的模型相对保守。
```

```
##  (Intercept)          age          lac          wbc          crp  typemedical 
## -30.66347321   0.29589768   1.95883166  -0.08536767   0.04402212   1.29144870 
##  typesurgery      vasoYes 
##  -3.30854523   3.27912029
```

## Decision curve analysis
一些重要概念：  

$$
\begin{aligned}
 Net\ benefit\ treated=\frac{TP}{n}-\frac{FP}{n}(\frac{p_t}{1-p_t})
\end{aligned}
$$
  
>where TP and FP are true positive count and false positive count, respectively; n is the number of subjects; and $p_t$ is the threshold probability. A model is said to be superior to another at the chosen threshold probability $p_t$ if its net benefit surpasses the net benefit of the other model for that value of $p_t$.

参考文献： Zhang Z, Rousson V, Lee WC, Ferdynus C, Chen M, Qian X, Guo Y; written on behalf of AME BigData Clinical Trial Collaborative Group. Decision curve analysis: a technical note. Ann Transl Med 2018. doi: 10.21037/atm.2018.07.02

```r
> library(rmda)
> mod1.dca <- decision_curve(mort ~ age + lac + wbc + crp + type + vaso, data = dtcom, 
+     study.design = "cohort", policy = "opt-in", bootstraps = 150)
```

```
## Note:  The data provided is used to both fit a prediction model and to estimate the respective decision curve. This may cause bias in decision curve estimates leading to over-confidence in model performance.
```

```r
> mod2.dca <- decision_curve(mort ~ age + vaso, data = dtcom, study.design = "cohort", 
+     policy = "opt-in", bootstraps = 150)
```

```
## Note:  The data provided is used to both fit a prediction model and to estimate the respective decision curve. This may cause bias in decision curve estimates leading to over-confidence in model performance.
```

```r
> plot_decision_curve(list(mod1.dca, mod2.dca), curve.names = c("mod1", "mod2"), xlim = c(0, 
+     1), legend.position = "bottomleft")
```

```
## Note: When multiple decision curves are plotted, decision curves for 'All' are calculated using the prevalence from the first DecisionCurve object in the list provided.
```

![](预测模型构建_files/figure-html/DCA-1.png)<!-- -->

## Nomogram (模型的可视化——列线图)
参考文献：Zhang Z, Kattan MW. Drawing Nomograms with R: applications to categorical outcome and survival data. Ann Transl Med. 2017 May;5(10):211. doi: 10.21037/atm.2017.04.01.

```r
> library(regplot)
```

```
## Registered S3 methods overwritten by 'lme4':
##   method                          from
##   cooks.distance.influence.merMod car 
##   influence.merMod                car 
##   dfbeta.influence.merMod         car 
##   dfbetas.influence.merMod        car
```

```r
> regplot(mod1, droplines = T, observation = dtcom[3, ], interval = "confidence")
```

```
## Regression  mod1 glm formula:
```

```
## mort `~` age + lac + wbc + crp + type + vaso
```

```
## CI: 0.994(0.966,0.999)
```

![](预测模型构建_files/figure-html/unnamed-chunk-11-1.png)<!-- -->

```
## [1] "note: points tables not constructed unless points=TRUE "
```







